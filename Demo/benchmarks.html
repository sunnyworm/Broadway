<!DOCTYPE html>
<html>

<head>
<style>
/* MetaWebPro font family licensed from fontshop.com. WOFF-FTW! */
@font-face {
	font-family: 'MetaBlack';
	src: url('http://mozcom-cdn.mozilla.net/img/fonts/MetaWebPro-Black.eot');
	src: local('â˜º'),
		url('http://mozcom-cdn.mozilla.net/img/fonts/MetaWebPro-Black.woff')
		format('woff');
	font-weight: bold;
}
</style>
</head>
<body>
  <meta charset="utf-8">

  <style>

  #site-title {
    display: block;
    font: normal bold 60px/.738 MetaBlack, "Arial Black", sans-serif;
    letter-spacing: -0.02em;
  }
  
  #doc {
    margin: 0 auto;
    width: 1200px;
    padding: 10px;
  }
  
  #tagline {
    clear: both;
    font: 1.538em/1.4 Georgia, sans-serif;
    color: #484848;
    padding: 0 430px 0 0px;
  }
  
  body {
    font: normal 16px/.738 MetaBlack, "Arial Black", sans-serif;
  	color: #6D7581;
  }
  
  #controls {
    padding: 10px;
    height: 40px;
  }
  
  </style>

  <link type="text/css" href="jquery/theme/jquery-ui.css" rel="stylesheet" />
  <script type="text/javascript" src="jquery/jquery.min.js"></script>
  <script type="text/javascript" src="jquery/jquery-ui.min.js"></script>

  <script src="sylvester.js" type="text/javascript"></script>
  <script src="glUtils.js" type="text/javascript"></script>
  
  <script src='util.js' type='text/javascript'></script>
  <script src='canvas.js' type='text/javascript'></script>

  <script type="text/javascript">
    $(function() {
      $("#play").button();
      $("#play").click(function() {
          test();
      });
    });

    function log(msg) {
      console.log(msg);
      $("#results").append("<p>" + msg + "</p>");
    }
    function sync(name, fn, count, cont) {
      var start = Date.now();
      for (var i = 0; i < count; i++) {
        fn();  
      }
      cont(name, Date.now() - start, count);
    }
    
    var loopID = 1;
    function async(name, fn, count, cont) {
      var start = Date.now();
      var id = loopID ++;
      var i = 0;
      window.addEventListener("message", function(event) {
        if (event.data == id) {
          fn();
          if (i++ < count) {
            window.postMessage(id, "*");
          } else {
            cont(name, Date.now() - start, count);
          }
        }
      });
      window.postMessage(id, "*");
    }
    
    function test() {
      
      // var size = new Size(16, 8);
      
      var size = new Size(128, 128);
      var c0 = new FilterWebGLCanvas(document.getElementById('canvas-0'), size);
      var buffer = new Uint8Array(size.w * size.h * 4);
      
      for (var i = 0; i < buffer.length; i += 4) {
        buffer[i] = 0;
        buffer[i + 1] = Math.random() * 255;
        buffer[i + 2] = 0;
        buffer[i + 3] = 255;
      }
      
      var pixels = new Uint8Array(size.length() * 4);
      
      var samples = 1000; // 3600 * 2;
      sync("Upload Data", function () {
        // c0.texture.fill(buffer);
        // c0.drawScene();
        // c0.readPixels(pixels);
        
        c0.process(buffer, pixels);
      }, samples, function (name, elapsed, count) {
        var opsPerSecond = (count / elapsed) * 1000;
        var msPerOp = (elapsed / count);
        var msg = name + " - Elapsed: " + elapsed + 
                  " ms, Count: " + count + 
                  ", Rate: " + opsPerSecond.toFixed(2) + " op/s, " + 
                  msPerOp.toFixed(3) + " ms/op";
        log(msg);
      });
      
      // console.log(out);
      
      var canvas = document.getElementById('canvas-0-out');
      canvas.width = size.w;
      canvas.height = size.h;
      var canvasContext = canvas.getContext("2d");
      var imageData = canvasContext.createImageData(size.w, size.h);
      imageData.data.set(pixels);
      canvasContext.putImageData(imageData, 0, 0);
      
      return;
      
      // var size = new Size(1280, 720);
      size = new Size(16, 16);
      var buffer = new Uint8Array(size.w * size.h);
      for (var i = 0; i < buffer.length; i++) {
        buffer[i] = i;
      }
      
      var samples = 500;

      var benchTimeLoop = function() {
        sync("Empty Time Loop", function () {
          // Nop.
        }, samples);
      };
      
      var benchEventLoop = function() {
        async("Empty Event Loop", function () {
          // Nop.          
        }, samples);
      };

      var c1 = new WebGLCanvas(document.getElementById('canvas-1'), size);
      
      var benchFillTexture = function(run) {
        run("Fill Texture", function () {
          c1.texture.fill(buffer);
        }, samples);
      };
      
      var benchDrawScene = function(run) {
        run("Draw Scene", function () {
          c1.drawScene();
        }, samples);
      };
      
      var benchFillTextureAndDrawScene = function(run) {
        run("Fill Texture + Draw Scene", function () {
          c1.texture.fill(buffer);  
          c1.drawScene();
        }, samples);
      };
      
      var chroma = new Uint8Array((size.w >>> 1) * (size.h >>> 1));
      for (var i = 0; i < chroma.length; i++) {
        chroma[i] = i;
      }
      
      var c2 = new YUVWebGLCanvas(document.getElementById('canvas-2'), size);
      
      var benchYUVFillTexture = function(run) {
        run("YUV Fill Texture", function () {
          c2.YTexture.fill(buffer);
          c2.UTexture.fill(chroma);
          c2.VTexture.fill(chroma);
        }, samples);
      };
      
      var benchYUVDrawScene = function(run) {
        run("YUV Draw Scene", function () {
          c2.drawScene();
        }, samples);
      };
      
      var benchYUVFillTextureAndDrawScene = function(run) {
        run("YUV Fill Texture + Draw Scene", function () {
          c2.YTexture.fill(buffer);
          c2.UTexture.fill(chroma);
          c2.VTexture.fill(chroma);
          c2.drawScene();
        }, samples);
      };
      
      var benchmarks = [];
      // benchmarks.push(benchTimeLoop);
      // benchmarks.push(benchEventLoop);
      
      benchmarks.push(benchFillTexture);
      benchmarks.push(benchDrawScene);
      benchmarks.push(benchFillTextureAndDrawScene);
      
      benchmarks.push(benchYUVFillTexture);
      benchmarks.push(benchYUVDrawScene);
      benchmarks.push(benchYUVFillTextureAndDrawScene);
      
      var nextBenchmarkMessage = "nextBenchmarkMessage";
      window.addEventListener("message", function(event) {
        if (event.data == nextBenchmarkMessage) {
          var benchmark = benchmarks.pop();
          console.log("Executing Benchmark: " + benchmark);
          benchmark(function(name, fn, count) {
            async(name, fn, count, function (name, elapsed, count) {
              var opsPerSecond = (count / elapsed) * 1000;
              var msPerOp = (elapsed / count);
              var msg = name + " - Elapsed: " + elapsed + 
                        " ms, Count: " + count + 
                        ", Rate: " + opsPerSecond.toFixed(2) + " op/s, " + 
                        msPerOp.toFixed(3) + " ms/op";
              log(msg);
              if (benchmarks.length > 0) {
                window.postMessage(nextBenchmarkMessage, "*");
              }
            })
          });
        }
      }, false);
      
      window.postMessage(nextBenchmarkMessage, "*")
    }
  </script>

  <div id="doc">
    <header>
      <h1 id="site-title"><b>Broadway.js Benchmarks</b></h1>
    </header>
    <div id="setting">
      <canvas id='canvas-0' style="background-color: red;" width="10" height="10"></canvas>
      <canvas id='canvas-0-out' style="background-color: blue;" width="10" height="10"></canvas>
      <canvas id='canvas-1' style="background-color: green;" width="10" height="10"></canvas>
      <canvas id='canvas-2' style="background-color: yellow;" width="10" height="10"></canvas>
      <div id="controls">
          <button id="play">Run</button>
      </div>
    </div>
    <div id="results"></div>
  </body>
</html>