<!DOCTYPE html>
<html>

<head>
<style>
/* MetaWebPro font family licensed from fontshop.com. WOFF-FTW! */
@font-face {
	font-family: 'MetaBlack';
	src: url('http://mozcom-cdn.mozilla.net/img/fonts/MetaWebPro-Black.eot');
	src: local('â˜º'),
		url('http://mozcom-cdn.mozilla.net/img/fonts/MetaWebPro-Black.woff')
		format('woff');
	font-weight: bold;
}
</style>
</head>
<body>
  <meta charset="utf-8">

  <style>

  #site-title {
    display: block;
    font: normal bold 60px/.738 MetaBlack, "Arial Black", sans-serif;
    letter-spacing: -0.02em;
  }
  
  #doc {
    margin: 0 auto;
    width: 1000px;
  }
  
  #setting {
    margin-top: 10px;
  }
  
  #tagline {
    clear: both;
    font: 1.538em/1.4 Georgia, sans-serif;
    color: #484848;
    padding: 0 430px 0 0px;
  }
  
  body {
    font: normal 16px/.738 MetaBlack, "Arial Black", sans-serif;
  	color: #6D7581;
  }
  
  select {
    font: normal 16px "Arial", sans-serif;
    padding: 1px;
    color: #6D7581;
  }
  
  th {
  	text-align: left;
  	padding: 4px 4px 4px 12px;
  	background: no-repeat;
  }
  
  td {
  	padding-left: 8px;
  	text-align: right;
  }
  
  
  </style>

  <link type="text/css" href="jquery/jquery-ui.css" rel="stylesheet" />
  <script type="text/javascript"
    src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
  <script type="text/javascript"
    src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
  <script language="javascript" type="text/javascript"
    src="jquery/jquery-flot.js"></script>

  <script type='text/javascript'>
    var Module = {
        noInitialRun : true
    };
  </script>

  <script src='broadway.js' type='text/javascript'></script>
  <script src="sylvester.js" type="text/javascript"></script>
  <script src="glUtils.js" type="text/javascript"></script>
  <script src='canvas.js' type='text/javascript'></script>

  <script type="text/javascript">
    $(function() {
        $("#tabs").tabs();
        $("button").button();
        $("#play").click(function() {
            play();
        });
        $("#plot").click(function() {
            plot();
        });
    });

    var options = {
        series : {
            shadowSize : 0
        },
        yaxis : {
            min : 0,
            max : 100
        },
        xaxis : {
            show : false
        },
        lines : {
            show : true
        },
        points : {
            show : true
        }
    };

    var fpsData = [];
    var fpsSinceStartData = [];

    function updateChart() {
        var plot = $.plot($("#chart"), [{
            data : fpsData,
            lines : {
                show : true
            },
            color : "rgb(255, 100, 123)"
        }, {
            data : fpsSinceStartData,
            lines : {
                show : true
            },
            points : {
                show : false
            },
            color : "rgb(0, 255, 0)"
        }], options);
        plot.draw();
    }

    var scoreCalculated = false;

    var plotting = false;
    var polluted = false;

    function plot() {
        plotting = !plotting;
        if (plotting) {
            polluted = true;
        }
    }

    var steadySampleCounter = 0;
    var steadyFpsCounter = 0;

    function updateStats(fps, fpsSinceStart, elapsed) {
        if (plotting) {
            var maxSamples = 32;
            if (fpsData.length > maxSamples)
                fpsData = fpsData.slice(1);
            fpsData.push([elapsed, fps])
            if (fpsSinceStartData.length > maxSamples)
                fpsSinceStartData = fpsSinceStartData.slice(1);
            fpsSinceStartData.push([elapsed, fpsSinceStart])
            updateChart();
        }

        var steadyElapsedThreshold = 5;
        if (elapsed > steadyElapsedThreshold) {
            steadySampleCounter++;
            steadyFpsCounter += fps;
        }

        document.getElementById('fps').innerHTML = fps.toFixed(2);
        document.getElementById('fpsSinceStart').innerHTML = fpsSinceStart.toFixed(2);
        document.getElementById('fpsSinceSteady').innerHTML = (steadyFpsCounter / steadySampleCounter).toFixed(2);
        document.getElementById('elapsed').innerHTML = elapsed.toFixed(2);

        var scoreTimeout = 60;
        if (elapsed > scoreTimeout && scoreCalculated == false) {
            scoreCalculated = true;
            document.getElementById('score').innerHTML = fpsSinceStart.toFixed(2);
        }
        if (scoreCalculated == false) {
            if (polluted) {
                document.getElementById('score').innerHTML = "Invalid";
            } else {
                document.getElementById('score').innerHTML = "Calculating: "
                        + (scoreTimeout - elapsed).toFixed(0);
            }
        }
    }

    function stop() {
        clearInterval(Module.mainLoopInterval);
    }


    function play() {
        $("#play").hide();
        document.getElementById('downloadProgress').innerHTML = "Downloading, Please Wait ...";
        var clip = $("#clip").val();
        var mode = $("#mode").val();
        var xhr = new XMLHttpRequest();
        xhr.open("GET", clip, false);
        xhr.responseType = "arraybuffer";
        xhr.send(null);
        var arrayBuffer = xhr.response;
        if (arrayBuffer) {
            var byteArray = new Uint8Array(arrayBuffer);
            var array = Array.prototype.slice.apply(byteArray);
            Module.FS.createDataFile('/', 'video.264', array, true, false);
        } else {
            alert('load fail :(');
        }
        document.getElementById('downloadProgress').innerHTML = "Download Complete, Playing ...";
        
        // Pass canvas and context to the generated code, and do the actual run() here
        Module.canvas = document.getElementById('canvas');
        
        if (mode == "none") {
            _paint = function () {};
            _SDL_LockSurface = function () {}
        } else if (mode == "webgl") {
            _paint = paint;
            _SDL_LockSurface = function () {}
        } else {
          Module.ctx2D = Module.canvas.getContext('2d');
          if (!Module.ctx2D) {
              alert('Canvas not available :(');
              return;
          }
        }
            
        console.info("Running: " + clip);
        Module.run(['video.264']);
    }
    
    var glCanvasInitialized = false;
    
    function paint($luma, $cb, $cr, height, width) {
      if (glCanvasInitialized == false) {
        initWebGLCanvas(Module.canvas, width, height);
        glCanvasInitialized = true;
      }
      var luma = HEAPU8.subarray($luma);
      var cb = HEAPU8.subarray($cb);
      var cr = HEAPU8.subarray($cr);
      paintLuma(width, height, luma);
    }
  </script>

  <script id="shader-fs" type="x-shader/x-fragment">
    varying highp vec2 vTextureCoord;
    uniform sampler2D uSampler;
    void main(void) {
        gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
    }
  </script>
  <script id="shader-vs" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;
    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
    varying highp vec2 vTextureCoord;
    void main(void) {
      gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
      vTextureCoord = aTextureCoord;
    }
  </script>

  <div id="doc">
    <header>
      <h1 id="site-title"><b>Broadway.js</b></h1>
      <p id="tagline">An H.264 Decoder in Pure JavaScript</p>
    </header>
    <div>
      <div id="setting">
        <span>Clip: 
          <select id="clip" style="margin-left: 10px;">
            <option value="mozilla.264">Mozilla</option>
            <option value="admiral.264">Admiral</option>
          </select>
        </span>
        <span style="margin-left: 10px; border: 0px" id="downloadProgress"></span>
      </div>
      <div id="setting">
        <span>Render Mode: 
          <select id="mode" style="margin-left: 10px;">
            <option value="canvas">Canvas</option>
            <option value="webgl">Canvas w/ WebGL</option>
            <option value="none">None</option>
          </select>
        </span>
        <span style="margin-left: 10px; border: 0px" id="downloadProgress"></span>
      </div>
      <div id="setting">
        <button id="plot" style="margin-right: 10px;">Plot</button>
        <button id="play">Play</button>
      </div>
      <div style="width: 1000px">
        <div style="width: 640px; height: 480px; margin-top: 10px; margin-bottom: 10px; float: left;">
          <canvas id='canvas' width="640" height="480"></canvas>
        </div>
        <!-- Stats -->
        <div
          style="height: 480px; margin-top: 10px; margin-left: 10px; margin-bottom: 10px; float: left;">
          <div id="chart" style="width: 300px; height: 340px;"></div>
          <table style="margin-top: 10px; width: 300;">
            <tr>
              <th>FPS</th>
              <td><span id='fps' style="color: red;"></span></td>
            </tr>
            <tr>
              <th>Average FPS (All / Steady)</th>
              <td><span id='fpsSinceStart' style="color: green;"></span>
                <span id='fpsSinceSteady' style="color: green;"></span></td>
            </tr>
            <tr>
              <th>Elapsed</th>
              <td><span id='elapsed'></span></td>
            </tr>
            <tr>
              <th>Score</th>
              <td><span id='score' style="color: brown;"></span></td>
            </tr>
          </table>
        </div>
      </div>
      
    </div>
  </body>
</html>